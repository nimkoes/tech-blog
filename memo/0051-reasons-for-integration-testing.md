# 통합 테스트를 하는 이유

- 단위 테스트에만 전적으로 의존하면 시스템이 전체적으로 잘 동작하는지 확신할 수 없다.
- 단위 테스트가 비즈니스 로직을 확인하는 데 좋지만, 비즈니스 로직을 외부와 단절된 상태로 확인하는 것만으로는 충분하지 않다.

# 통합 테스트는 무엇인가?

## 통합 테스트의 역할

단위 테스트는 다음 세 가지 요구 사항을 충족하는 테스트다.

- 단일 동작 단위를 검증하고
- 빠르게 수행하고
- 다른 테스트와 별도로 처리한다.

이 세 가지 요구 사항 중 하나라도 충족하지 못하는 테스트는 통합 테스트 범주에 속한다.  
단위 테스트가 아닌 모든 테스트가 통합 테스트에 해당한다.

통합 테스트는 대부분 시스템이 프로세스 외부 의존성과 통합해 어떻게 작동하는지를 검증한다. 다시 말해, 이 테스트는 컨트롤러 사분면에 속하는 코드를 다룬다.

|                 | 협력자 수 ↓      | 협력자수 ↑      |
|-----------------|--------------|-------------|
| 복잡도 및 도메인 유의성 ↑ | 도메인 모델과 알고리즘 | 지나치게 복잡한 코드 |
| 복잡도 및 도메인 유의성 ↓ | 간단한 코드       | 컨트롤러        |

- 단위 테스트 : 도메인 모델과 알고리즘
- 컨트롤러 : 통합 테스트

간단한 코드와 지나치게 복잡한 코드는 전혀 테스트해서는 안 된다.  
컨트롤러 사분면을 다루는 ㅔ스트가 단위 테스트일 수도 있다.  
모든 프로세스 외부 의존성을 목으로 대체하면 테스트 간에 공유하는 의존성이 없어지므로 테스트 속도가 빨라지고 서로 격리될 수 있다.  
그러나 대부분의 애플리케이션은 목으로 대체할 수 없는 프로세스 외부 의존성이 있다. (ex, 데이터베이스)

## 다시 보는 테스트 피라미드

통합 테스트가 프로세스 외부 의존성에 직접 작동하면 느려지며, 이러한 테스트는 유지비가 많이 든다. 유지비 증가의 이유는 다음과 같다.

- 프로세스 외부 의존성 운영이 필요함
- 관련된 협력자가 많아서 테스트가 비대해짐

통합 테스트는 코드를 더 많이 거치므로 회귀 방지가 단위 테스트보다 우수하다. 또한 제품 코드와의 결합도가 낮아서 리팩터링 내성도 우수하다.  
단위 테스트와 통합 테스트의 비율은 프로젝트의 특성에 따라 다를 수 있지만, 일반적인 경험에 비춰본 규칙은 다음과 같다. 단위 테스트로 가능한 한 많이 비즈니스 시나리오의 예외 상황을 확인하고, 통합 테스트는 주요 흐름(happy path)과 단위 테스트가 다루지 못하는 기타 예외 상황(edge case)을 다룬다.  
정의> 주요 흐름(happy path)은 시나리오의 성공적인 실행이다. 예외 상황은 비즈니스 시나리오 수행 중 오류가 발생하는 경우다.

## 통합 테스트와 빠른 실패

이 절에서는 통합 테스트를 사용해 비즈니스 시나리오당 하나의 주요 흐름과 단위 테스트로 처리할 수 없는 모든 예외 상황을 다루는 지침을 자세히 설명한다.

- 통합 테스트: 외부 시스템과의 상호작용을 실제로 확인하는 “긴 주요 흐름”에 집중.
- 단위 테스트: 도메인 로직의 전제 조건, 사전 검증 로직, 빠른 실패 조건 등을 집중적으로 확인.
- 른 실패(Fast Fail): 치명적인 오류를 초기에 발견해, 통합 테스트를 줄이는 효과를 제공.

- 외부 환경이 있어야만 발생하는 예외 → 통합 테스트 필요
- 잘못된 호출 시 바로 터지고 데이터도 안전 → 굳이 통합 테스트 안 해도 됨, 단위 테스트나 첫 실행에서 잡힘

| 예외 상황 유형                        | 설명                                           | 테스트 방법             | 이유                                         |
|---------------------------------|----------------------------------------------|--------------------|--------------------------------------------|
| **단위 테스트에 다룰 수 없는 예외 상황**       | 외부 시스템(DB, API, 파일 등)과 실제 상호작용이 있어야만 발생하는 예외 | 통합 테스트             | 모의(Mock) 객체로 재현이 불가능하고, 실제 환경에서만 발생 가능     |
| **빠른 실패(Fast Fail)로 잡히는 예외 상황** | 잘못된 호출 시 애플리케이션이 즉시 예외를 던지고 멈추며, 데이터 손상 없음   | 단위 테스트 또는 개발 초기 실행 | 첫 실행 시 바로 버그가 드러나고, 복잡한 통합 테스트를 작성할 필요가 없음 |

“즉시 실패하는 예외 상황”은 단위 테스트로 커버하고, 통합 테스트까지 만들 필요는 없다.

# 어떤 프로세스 외부 의존성을 직접 테스트해야 하는가?

- 통합 테스트는 시스템이 프로세스 외부 의존성과 어떻게 통합하는지를 검증한다.
- 이러한 검증을 구현하는 방식은 두 가지가 있다.
  - 실제 프로세스 외부 의존성을 사용
  - 해당 의존성을 목으로 대체

## 프로세스 외부 의존성의 두 가지 유형

모든 프로세스 외부 의존성은 두 가지 범주로 나뉜다.

### 관리 의존성

전체를 제어할 수 있는 프로세스 외부 의존성

- 이러한 의존성은 애플리케이션을 통해서만 접근할 수 있다.
- 해당 의존성과의 상호 작용은 외부 환경에서 볼 수 없다.
- 대표적인 예로 데이터베이스가 있다.

### 비관리 의존성

전체를 제어할 수 없는 프로세스 외부 의존성

- 해당 의존성과의 상호 작용을 외부에서 볼 수 있다.
- 예를 들어 SMTP 서버와 메시지 버스 등이 있다.

앞서 관리 의존성과의 통신은 구현 세부 사항이라고 했다.
반대로, 비관리 의존성과의 통신은 시스템의 식별할 수 있는 동작이다.

** 관리 의존성은 실제 인스턴스를 사용하고, 비관리 의존성은 목으로 대체하라.

## 관리 의존성이면서 비관리 의존성인 프로세스 외부 의존성 다루기

대표적으로, 다른 애플리케이션이 접근할 수 있는 데이터베이스
이런 경우 다른 애플리케이션에서 볼 수 있는 테이블을 비관리 의존성으로 취급하라.
통합 테스트에서 목으로 대체한다.
나머지 데이터베이스는 관리 의존성으로 취급하라.
상호 작용이 아닌 최종 상태를 검증하라.

## 통합 테스트에서 실제 데이터베이스를 사용할 수 없으면 어떻게 할까?

관리 의존성임에도 불구하고 데이터베이스를 목으로 대체하면 통합 테스트의 리팩터링 내성이 저하된다.
이렇게 하면 테스트는 회귀 방지로 떨어진다.

# 통합 테스트: 예제

- 통합 테스트에 대한 일반적인 지침은 가장 긴 주요 흐름과 단위 테스트로는 수행할 수 없는 모든 예외 상황을 다루는 것이다.
- 가장 긴 주요 흐름은 모든 프로세스 외부 의존성을 거치는 것이다.


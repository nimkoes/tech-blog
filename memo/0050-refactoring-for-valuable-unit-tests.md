# 리팩터링 할 코드 식별하기

## 코드의 네 가지 유형

모든 제품 코드는 2차원으로 분류할 수 있다.

- 코드 복잡도 (code complexity) 또는 도메인 유의성 (domain significance)
- 클래스 또는 메서드가 가진 협력자 수

코드 복잡도는 코드 내 의사결정(분기) 지점 수로 정의 한다. 이 숫자가 클수록 복잡도는 더 높아진다. 도메인 유의성은 코드가 프로젝트의 문제 도메인에 대해 얼마나 의미있는지를 나타낸다. 협력자는 가변 의존성이거나 프로세스 외부 의존성(또는 둘 다)이다.

코드 복잡도, 도메인 유의성, 협력자 슈의 조합으로 코드 유형을 네 가지로 구분할 수 있다.

### 도메인 모델과 알고리즘

보톨 복잡한 코드는 도메인 모델이지만, 100%는 아니다. 문제 도메인과 직접적으로 관련이 없는 복잡한 알고리즘이 있을 수 있다.

### 간단한 코드

C# 에서 이러한 코드의 예로 매개변수가 없는 생성자와 한 줄 속성 등이 있다. 협력자가 있는 경우가 거의 없고 복잡도나 도메인 유의성도 거의 없다.

### 컨트롤러

이 코드는 복잡하거나 비즈니스에 중요한 작업을 하는 것이 아니라 도메인 클래스와 외부 애플리케이션 같은 다른 구성 요소의 작업을 조정한다.

### 지나치게 복잡한 코드

이러한 코드는 두 가지 지표 모두 높다. 협력자가 많으며 복잡하거나 중요하다. 한 가지 예로 덩치가 큰 컨트롤러(복잡한 작업을 어디에도 위임하지 않고 모든 것을 스스로 하는 컨트롤러)가 있다.

|                 | 협력자 수 ↓      | 협력자수 ↑      |
|-----------------|--------------|-------------|
| 복잡도 및 도메인 유의성 ↑ | 도메인 모델과 알고리즘 | 지나치게 복잡한 코드 |
| 복잡도 및 도메인 유의성 ↓ | 간단한 코드       | 컨트롤러        |

지나치게 복잡한 코드를 알고리즘과 컨트롤러로 나눠서 리팩터링하라. 이상적으로는 '지나치게 복잡한 코드'가 있으면 안 된다.

## 험블 객체 패턴을 사용해 지나치게 복잡한 코드 분할하기

험블 객체 패턴은 지나치게 복잡한 코드에서 로직을 추출해 코드를 테스트할 필요가 없도록 간단하게 만든다. 추출된 로직은 테스트하기 어려운 의존성에서 분리된 다른 클래스로 이동한다.

육각형 아키텍처와 함수형 아키텍처 모두 정확히 이 패턴을 구현한다.

함수형 아키텍터의 함수형 코어와 육각형 아키텍처의 도메인 계층은 '도메인 모델과 알고리즘'에 속하며, 협력자가 거의 없고 복잡도와 도메인 유의성이 높다.
가변 셸(함수형 아키텍처)과 애플리케이션 서비스 계층(육각형 아키텍처)은 컨트롤러에 속한다.

# 가치 있는 단위 테스트를 위한 리팩터링하기

## 고객 관리 시스템 소개

- 명시적인 의존성과 암시적인 의존성
- 도메인 유의성이 높은 코드에서 프로세스 외부 협력자는 사용하면 안 된다.
- 도메인 클래스가 스스로 데이터베이스를 검색하고 다시 저장하는 이러한 방식을 활성 레코드 (Active Pattern) 패턴 이라고 한다.

## 1단계 : 암시적 의존성을 명시적으로 만들기

- 도메인 모델은 직접적으로든 간접적으로든 (인터페이스를 통해) 프로세스 외부 협력자에게 의존하지 않는 것이 훨씬 더 깔끔하다.
- 이것이 육각형 아키텍처에서 바라는 바다.
- 도메인 모델은 외부 시스템과의 통신을 책임지지 않아야 한다.

## 2단게 : 애플리케이션 서비스 계층 도입

- 도메인 모델이 외부 시스템과 직접 통신하는 문제를 극복하려면 다른 클래스인 험블 컨트롤러 (humble controller, 육각형 아키텍처 분류상 애플리케이션 서비스) 로 책임을 옮겨야 한다.
- 일반적으로 도메인 클래스는 다른 도메인 클래스나 단순 값과 같은 프로세스 내부 의존성에만 의존해야 한다.
- 애플리케이션 서비스의 역할은 복잡도나 도메인 유의성의 로직이 아니라 오케스트레이션만 해당한다.

## 3단계 : 애플리케이션 서비스 복잡도 낮추기

- 재구성 로직(Reconstitution Logic) 이 단순해 보이더라도 실제로는 내부적으로 많은 분기(branch)가 숨어 있어서 테스트할 가치가 있다

## 4단계 : 새 Company 클래스 소개

- tell don't ask 원칙
- 




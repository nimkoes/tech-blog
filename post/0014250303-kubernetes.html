<!DOCTYPE html><html lang="ko" class="__className_c5102c"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/tech-blog/_next/static/media/a34f9d1faa5f3315-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/tech-blog/_next/static/css/2902b82ade31b364.css" data-precedence="next"/><link rel="stylesheet" href="/tech-blog/_next/static/css/86708423b213bf15.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/tech-blog/_next/static/chunks/webpack-55be747906e2abed.js"/><script src="/tech-blog/_next/static/chunks/fd9d1056-12d0224c61359539.js" async=""></script><script src="/tech-blog/_next/static/chunks/117-d2d2b15d916da2d9.js" async=""></script><script src="/tech-blog/_next/static/chunks/main-app-dc241a590481c956.js" async=""></script><script src="/tech-blog/_next/static/chunks/679-09931d2c20ac23c4.js" async=""></script><script src="/tech-blog/_next/static/chunks/app/layout-04b5cc4ae96ec103.js" async=""></script><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6151583773425822" crossorigin="anonymous"></script><script src="/tech-blog/_next/static/chunks/app/post/%5Bslug%5D/page-5fc1a46522590ee2.js" async=""></script><meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)"/><meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)"/><meta name="naver-site-verification" content="1df124e1d8331da4467178ffddd6188e1d413576"/><meta name="google-adsense-account" content="ca-pub-6151583773425822"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="dns-prefetch" href="https://fonts.gstatic.com"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="anonymous"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><title>Pod - ReadinessProbe, LivenessProb | Nimkoes Tech Blog</title><meta name="description" content="기본 설명"/><meta name="application-name" content="Nimkoes Tech Blog"/><link rel="author" href="https://nimkoes.github.io/tech-blog"/><meta name="author" content="Nimkoes"/><link rel="manifest" href="/tech-blog/site.webmanifest" crossorigin="use-credentials"/><meta name="keywords" content="tech-blog,backend,software architect,infrastructure,development"/><meta name="creator" content="Nimkoes"/><meta name="publisher" content="Nimkoes"/><meta name="robots" content="index, follow, nocache"/><meta name="googlebot" content="index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1"/><meta name="category" content="technology"/><link rel="canonical" href="https://nimkoes.github.io/tech-blog"/><link rel="alternate" hrefLang="ko-KR" href="https://nimkoes.github.io/tech-blog"/><meta name="format-detection" content="telephone=no, address=no, email=no"/><meta name="google-adsense-account" content="ca-pub-6151583773425822"/><meta property="og:title" content="Nimkoes Tech Blog - 개발자의 기술 이야기"/><meta property="og:description" content="I work diligently to become lazy ☕"/><meta property="og:url" content="https://nimkoes.github.io/tech-blog"/><meta property="og:site_name" content="Nimkoes Tech Blog"/><meta property="og:locale" content="ko_KR"/><meta property="og:image" content="https://nimkoes.github.io/tech-blog/og-image.png"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:image:alt" content="Nimkoes Tech Blog"/><meta property="og:image:type" content="image/png"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@nimkoes"/><meta name="twitter:creator" content="@nimkoes"/><meta name="twitter:title" content="Nimkoes Tech Blog"/><meta name="twitter:description" content="I work diligently to become lazy ☕"/><meta name="twitter:image" content="https://nimkoes.github.io/tech-blog/og-image.png"/><link rel="icon" href="/tech-blog/favicon.ico" sizes="any"/><link rel="icon" href="/tech-blog/icon.svg" type="image/svg+xml"/><link rel="icon" href="/tech-blog/favicon-32x32.png" sizes="32x32" type="image/png"/><link rel="icon" href="/tech-blog/favicon-16x16.png" sizes="16x16" type="image/png"/><link rel="apple-touch-icon" href="/tech-blog/apple-touch-icon.png" sizes="180x180" type="image/png"/><link rel="mask-icon" href="/tech-blog/safari-pinned-tab.svg" color="#5bbad5"/><meta name="next-size-adjust"/><script src="/tech-blog/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="layout_home__0Lbpw"><aside class="NavigationView_navigationView__9z_1q"><div class="NavigationView_navigation__E0_xU"><button class="Button_button__aem_D Button_icon__S9jrr Button_medium__xLUiz NavigationView_navButton__QKsJg " aria-label="카테고리 보기"></button><button class="Button_button__aem_D Button_icon__S9jrr Button_medium__xLUiz NavigationView_navButton__QKsJg " aria-label="로그 보기"></button></div></aside><div class="layout_page__rCnOA" style="height:100vh"><div class="layout_subPage__irpRs"><div class="layout_contentsView__k4Q_k contentsView"><div><header class="PostHeader_postHeader__OohTH"><h1 class="PostHeader_title__NoKGt">Pod - ReadinessProbe, LivenessProb</h1><p class="PostHeader_description__moC_r"></p><div class="PostHeader_meta__9Swgx"><span>nimkoes</span><span>2021-03-02</span></div><div class="PostHeader_tags__lGQ1Q"><span class="PostHeader_tag__Jf7BC">Kubernetes</span><span class="PostHeader_tag__Jf7BC">k8s</span><span class="PostHeader_tag__Jf7BC">infra</span></div></header><div class="TableOfContents_tocWrapper__wUNrb "><div class="TableOfContents_tocBox__GAFU7"><div class="TableOfContents_tocHeader__EikQq"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="4" width="20" height="16" rx="3" stroke="#CCCCCC" stroke-width="1.5"></rect><circle cx="6" cy="8" r="1.5" fill="#CCCCCC"></circle><circle cx="6" cy="12" r="1.5" fill="#CCCCCC"></circle><circle cx="6" cy="16" r="1.5" fill="#CCCCCC"></circle><line x1="9" y1="8" x2="18" y2="8" stroke="#CCCCCC" stroke-width="1.5"></line><line x1="9" y1="12" x2="18" y2="12" stroke="#CCCCCC" stroke-width="1.5"></line><line x1="9" y1="16" x2="18" y2="16" stroke="#CCCCCC" stroke-width="1.5"></line></svg><span class="TableOfContents_tocText__Mmsk2">Table of Contents</span></div><ul></ul></div></div><article class="page_markdown__SVl4d"><div class="KakaoAdFit_adContainer__TWxMq page_topAd__ctbB7"></div><div><p><img src="/tech-blog/resources/images/kubernetes/0014-01.png" alt="0014-01"></p>
<p>Pod 를 만들면 그 안에 Container 가 생기고 Pod 와 Container 의 상태가 Running 이 되면서 그 안에 있는 Application 도 정상적으로 구동이 되고 있을 것이다. 그리고
Service 에 연결 되는데 이 Service 의 IP 가 외부에 노출되어 다수의 사용자에 의해 서비스가 이용 된다.</p>
<p><img src="/tech-blog/resources/images/kubernetes/0014-02.png" alt="0014-02"></p>
<p>현재 하나의 Service 에 두 개의 Pod 가 연결되어 있고 트래픽이 반으로 나뉜다고 하자. 이 때 Node2 서버가 문제가 생겨 다운이 된 경우 그 위의 Pod 도 Failed 가 되면서 사용자의 모든 트래픽이
Pod1 로 들어가게 된다.</p>
<p><img src="/tech-blog/resources/images/kubernetes/0014-03.png" alt="0014-03"></p>
<p>Pod1 이 트래픽을 견뎌준다면 서비스를 유지하는데 문제는 없다. 다운이 된 Pod2 는 Auto Healing 기능에 의해 다른 Node 에 생성을 시도 한다. 그 과정에서 Pod 와 Container 가
Running 상태가 되면서 Service 와 연결 되는데 Application 이 구동 중인 순간이 발생 한다.</p>
<p>Service 와 연결이 되자 마자 트래픽이 Pod2 로 유입되기 때문에 Application 이 구동 되는 동안 사용자는 50% 확률로 Error 페이지를 보게 되는 경우가 생기게 된다.</p>
<p><img src="/tech-blog/resources/images/kubernetes/0014-04.png" alt="0014-04"></p>
<p>Pod 를 만들 때 ReadinessProbe 를 주게 되면 이런 문제를 피할 수 있다. ReadinessProbe 가 Application 이 완전히 구동 되기 전에는 Service 와 연결되지 않도록 해주기
때문이다. 따라서 Pod2 의 상태는 Running 이지만 트래픽은 계속 Pod1 에만 유입 되고 Application 이 완전히 구동 된 것이 확인 되면 Service 와 연결 되면서 트래픽이 분산 된다.</p>
<p><img src="/tech-blog/resources/images/kubernetes/0014-05.png" alt="0014-05"></p>
<p>서비스 운영 중 갑자기 Application 에 장애가 발생할 수 있다. 이건 서버에는 문제가 없는데 그 위에 동작하는 Application 자체에만 문제가 생긴 경우와 같다.</p>
<p><img src="/tech-blog/resources/images/kubernetes/0014-06.png" alt="0014-06"></p>
<p>이런 상황을 감지해 주는 게 LivenessProbe 이다. Pod 를 만들 때 LivenessProbe 를 설정하면 Application 에 문제가 발생할 경우 Pod 를 다시 생성하도록 하여 잠시 동안 트래픽
에러는 발생 하지만 지속적으로 에러가 발생하는 것은 방지해 준다.</p>
<p>즉, ReadinessProbe 를 설정하여 Application 구동 중 트래픽 실패를 방지하고, LivenessProbe 를 설정하여 Application 장애가 발생한 경우 지속적인 트래픽 실패를 방지할 수
있도록 해야 한다.</p>
<h1>ReadinessProbe, LivenessProbe</h1>
<p>하나의 Service 에 Pod 가 연결 되어 있는 상태에서 Pod 를 하나 더 생성 할 건데 이 Pod 는 Container 에 HostPath 로 Node 의 Volume 이 연결되어 있다. 기본적으로
ReadinessProbe 와 LivenessProbe 는 사용 목적만 다를 뿐이고 설정할 수 있는 내용은 동일하다.</p>
<p><img src="/tech-blog/resources/images/kubernetes/0014-07.png" alt="0014-07"></p>
<p>공통으로 들어가는 속성들을 보면 크게 httpGet, Exec, tcpSocket 으로 해당 Application 의 상태를 확인할 수 있다.</p><h2>httpGet</h2>
<p>Port, Host, Path, HttpHeader, Scheme 을 확인할 수 있다.</p></div><div class="GoogleAdsense_adContainer__8AKIp page_middleAd__4qBOv"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6151583773425822" data-ad-slot="your-ad-slot-id" data-ad-format="auto" data-full-width-responsive="true"></ins></div><div><h2>Exec</h2>
<p>Command 를 사용해서 특정 명령어를 전송하여 그에 따른 결과를 확인할 수 있다.</p><h2>tcpSocket</h2>
<p>Port, Host 를 통해 ReadinessProbe 와 LivenessProbe 의 성공 여부를 확인할 수 있다.</p>
<p>추가로 설정할 수 있는 옵션 값이 있다.</p>
<ul>
<li>initialDelaySeconds
<ul>
<li>default : 0 초</li>
<li>최초 Probe 를 하기 전에 딜레이 시간</li>
</ul>
</li>
<li>periodSeconds
<ul>
<li>default : 10 초</li>
<li>Probe 를 체크하는 시간의 간격</li>
</ul>
</li>
<li>timeoutSeconds
<ul>
<li>default : 1 초</li>
<li>결과가 도착해야 하는 시간</li>
</ul>
</li>
<li>successThreshold
<ul>
<li>default : 1 회</li>
<li>몇 번 성공 결과를 받아야 정말 성공인지 설정</li>
</ul>
</li>
<li>failureThreshold
<ul>
<li>default : 3 회</li>
<li>몇 번 실패 결과를 받아야 정말 실패인지 설정</li>
</ul>
</li>
</ul>
<h1>ReadinessProbe</h1>
<p>Exec 를 사용해서 Command 로 ready.txt 파일을 조회 한다.</p>
<p><img src="/tech-blog/resources/images/kubernetes/0014-08.png" alt="0014-08"></p>
<p>최초 delay 5초, 체크 간격 10초, 3번 성공 시 정상 구동으로 설정했다면 Pod 를 만들 때 Node 가 Schedule 되고 이미지가 다운 받아 지면서 Pod 와 Container 상태는 Running 이
되지만 이 Probe 가 성공하기 전까지는 Condition 에 Container Ready 상태와 Ready 상태가 false 로 남아 있고 EndPoint 에서는 이 Pod 의 IP 를 NotReadyAddr 로
간주하고 Service 에 연결하지 않는다.</p>
<p><img src="/tech-blog/resources/images/kubernetes/0014-09.png" alt="0014-09"></p>
<p>k8s 는 ReadinessProbe 의 내용 대로 Application 의 기동 상태를 체크하는데, Container 상태가 Running 이 되면 최초 5초간 지연 하고 있다가 5초가 지나면 ready.txt
파일이 있는지 체크해보고, 파일이 없으면 10초 후에 다시 체크를 하게 된다.</p>
<p><img src="/tech-blog/resources/images/kubernetes/0014-10.png" alt="0014-10"></p>
<p>이 Node 에 Ready.txt 라는 데이터를 추가하면 Container 의 Volume 과 연결 되어 있기 때문에 다음에 ReadinessProbe 를 체크할 때 성공 결과를 받게 된다. 그리고 3번 성공하게
되면 Condition 의 상태는 true 가 되고 EndPoint 도 정상적으로 Address 로 간주 하면서 Service 와 연결 되게 된다.</p>
<h1>LivenessProbe</h1>
<p>하나의 Service 에 두 개의 Pod 가 Running 되고 있는 상태를 가정 한다. 이 중 한 Application 의 내용을 보면 /health 라는 요청을 보내면 Status 로 200을 주면서 서비스가
정상 운영 중이라는 Health Check 가 만들어져 있다.</p>
<p><img src="/tech-blog/resources/images/kubernetes/0014-11.png" alt="0014-11"></p>
<p>그리고 이 Container 에는 LivenessProbe 가 설정되어 있고, 내용은 httpGet 으로 path에 /health 경로를 체크 한다. 옵션으로는 최초 5초 지연과 10초 간격 체크 그리고 3번 실패
할 경우 Pod 가 재시작 하도록 설정 했다.</p>
<p><img src="/tech-blog/resources/images/kubernetes/0014-12.png" alt="0014-12"></p>
<p>k8s 가 httpGet 으로 5초 후에 해당 path 를 체크해보고 200 응답을 받을 것이다. 그리고 10초 후 다시 체크할 때고 200 응답을 받으면서 서비스가 정상 운영 중이라고 판단 하게 된다. 그러던 중
어느 순간 path 를 호출했을 때 Internal Server Error 를 발생 하면서 500 응답을 받았다고 하자. 하지만 Pod 는 Running 상태로 남아 있는다. 그렇게 3번을 500응답을 받게 되면
k8s 는 문제가 있다고 판단하고 이 Pod 를 Restart 한다.</p></div><div class="GoogleAdsense_adContainer__8AKIp page_bottomAd__f0OO_"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6151583773425822" data-ad-slot="your-ad-slot-id" data-ad-format="auto" data-full-width-responsive="true"></ins></div></article></div><div class="page_floatingButtons__qJiZU"><button class="GoToHome_goToHome__Es1L5"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 2L2 7V14H6V9H10V14H14V7L8 2Z" fill="currentColor"></path></svg></button></div><button class="ScrollToTop_scrollToTop__7NKxR " aria-label="Scroll to top" type="button"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3L3 8M8 3L13 8M8 3V13"></path></svg></button></div></div></div><script src="/tech-blog/_next/static/chunks/webpack-55be747906e2abed.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/tech-blog/_next/static/media/a34f9d1faa5f3315-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/tech-blog/_next/static/css/2902b82ade31b364.css\",\"style\"]\n3:HL[\"/tech-blog/_next/static/css/86708423b213bf15.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"4:I[2846,[],\"\"]\n7:I[4707,[],\"\"]\n9:I[6423,[],\"\"]\na:I[4829,[\"679\",\"static/chunks/679-09931d2c20ac23c4.js\",\"185\",\"static/chunks/app/layout-04b5cc4ae96ec103.js\"],\"default\"]\nc:I[1060,[],\"\"]\n8:[\"slug\",\"0014250303-kubernetes\",\"d\"]\nd:[]\n"])</script><script>self.__next_f.push([1,"0:[\"$\",\"$L4\",null,{\"buildId\":\"a1bFVU1NYHOPcC7wFbgit\",\"assetPrefix\":\"/tech-blog\",\"urlParts\":[\"\",\"post\",\"0014250303-kubernetes\"],\"initialTree\":[\"\",{\"children\":[\"post\",{\"children\":[[\"slug\",\"0014250303-kubernetes\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"0014250303-kubernetes\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"post\",{\"children\":[[\"slug\",\"0014250303-kubernetes\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L5\",\"$L6\",[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/tech-blog/_next/static/css/86708423b213bf15.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]]],null],null]},[null,[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"post\",\"children\",\"$8\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[null,[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"post\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/tech-blog/_next/static/css/2902b82ade31b364.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"ko\",\"className\":\"__className_c5102c\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"meta\",null,{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no\"}],[\"$\",\"meta\",null,{\"name\":\"theme-color\",\"content\":\"#ffffff\",\"media\":\"(prefers-color-scheme: light)\"}],[\"$\",\"meta\",null,{\"name\":\"theme-color\",\"content\":\"#000000\",\"media\":\"(prefers-color-scheme: dark)\"}],[\"$\",\"meta\",null,{\"name\":\"naver-site-verification\",\"content\":\"1df124e1d8331da4467178ffddd6188e1d413576\"}],[\"$\",\"meta\",null,{\"name\":\"google-adsense-account\",\"content\":\"ca-pub-6151583773425822\"}],[\"$\",\"link\",null,{\"rel\":\"dns-prefetch\",\"href\":\"https://fonts.googleapis.com\"}],[\"$\",\"link\",null,{\"rel\":\"dns-prefetch\",\"href\":\"https://fonts.gstatic.com\"}],[\"$\",\"link\",null,{\"rel\":\"preconnect\",\"href\":\"https://fonts.googleapis.com\",\"crossOrigin\":\"anonymous\"}],[\"$\",\"link\",null,{\"rel\":\"preconnect\",\"href\":\"https://fonts.gstatic.com\",\"crossOrigin\":\"anonymous\"}],[\"$\",\"script\",null,{\"async\":true,\"src\":\"https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6151583773425822\",\"crossOrigin\":\"anonymous\"}]]}],[\"$\",\"$La\",null,{\"children\":[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[]}]}]]}]],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$Lb\"],\"globalErrorComponent\":\"$c\",\"missingSlots\":\"$Wd\"}]\n"])</script><script>self.__next_f.push([1,"e:I[2089,[\"605\",\"static/chunks/app/post/%5Bslug%5D/page-5fc1a46522590ee2.js\"],\"default\"]\nf:I[3299,[\"605\",\"static/chunks/app/post/%5Bslug%5D/page-5fc1a46522590ee2.js\"],\"default\"]\n11:I[1040,[\"605\",\"static/chunks/app/post/%5Bslug%5D/page-5fc1a46522590ee2.js\"],\"default\"]\n13:I[2786,[\"605\",\"static/chunks/app/post/%5Bslug%5D/page-5fc1a46522590ee2.js\"],\"default\"]\n14:I[6798,[\"605\",\"static/chunks/app/post/%5Bslug%5D/page-5fc1a46522590ee2.js\"],\"default\"]\n10:Tde0,"])</script><script>self.__next_f.push([1,"\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-01.png\" alt=\"0014-01\"\u003e\u003c/p\u003e\n\u003cp\u003ePod 를 만들면 그 안에 Container 가 생기고 Pod 와 Container 의 상태가 Running 이 되면서 그 안에 있는 Application 도 정상적으로 구동이 되고 있을 것이다. 그리고\nService 에 연결 되는데 이 Service 의 IP 가 외부에 노출되어 다수의 사용자에 의해 서비스가 이용 된다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-02.png\" alt=\"0014-02\"\u003e\u003c/p\u003e\n\u003cp\u003e현재 하나의 Service 에 두 개의 Pod 가 연결되어 있고 트래픽이 반으로 나뉜다고 하자. 이 때 Node2 서버가 문제가 생겨 다운이 된 경우 그 위의 Pod 도 Failed 가 되면서 사용자의 모든 트래픽이\nPod1 로 들어가게 된다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-03.png\" alt=\"0014-03\"\u003e\u003c/p\u003e\n\u003cp\u003ePod1 이 트래픽을 견뎌준다면 서비스를 유지하는데 문제는 없다. 다운이 된 Pod2 는 Auto Healing 기능에 의해 다른 Node 에 생성을 시도 한다. 그 과정에서 Pod 와 Container 가\nRunning 상태가 되면서 Service 와 연결 되는데 Application 이 구동 중인 순간이 발생 한다.\u003c/p\u003e\n\u003cp\u003eService 와 연결이 되자 마자 트래픽이 Pod2 로 유입되기 때문에 Application 이 구동 되는 동안 사용자는 50% 확률로 Error 페이지를 보게 되는 경우가 생기게 된다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-04.png\" alt=\"0014-04\"\u003e\u003c/p\u003e\n\u003cp\u003ePod 를 만들 때 ReadinessProbe 를 주게 되면 이런 문제를 피할 수 있다. ReadinessProbe 가 Application 이 완전히 구동 되기 전에는 Service 와 연결되지 않도록 해주기\n때문이다. 따라서 Pod2 의 상태는 Running 이지만 트래픽은 계속 Pod1 에만 유입 되고 Application 이 완전히 구동 된 것이 확인 되면 Service 와 연결 되면서 트래픽이 분산 된다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-05.png\" alt=\"0014-05\"\u003e\u003c/p\u003e\n\u003cp\u003e서비스 운영 중 갑자기 Application 에 장애가 발생할 수 있다. 이건 서버에는 문제가 없는데 그 위에 동작하는 Application 자체에만 문제가 생긴 경우와 같다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-06.png\" alt=\"0014-06\"\u003e\u003c/p\u003e\n\u003cp\u003e이런 상황을 감지해 주는 게 LivenessProbe 이다. Pod 를 만들 때 LivenessProbe 를 설정하면 Application 에 문제가 발생할 경우 Pod 를 다시 생성하도록 하여 잠시 동안 트래픽\n에러는 발생 하지만 지속적으로 에러가 발생하는 것은 방지해 준다.\u003c/p\u003e\n\u003cp\u003e즉, ReadinessProbe 를 설정하여 Application 구동 중 트래픽 실패를 방지하고, LivenessProbe 를 설정하여 Application 장애가 발생한 경우 지속적인 트래픽 실패를 방지할 수\n있도록 해야 한다.\u003c/p\u003e\n\u003ch1\u003eReadinessProbe, LivenessProbe\u003c/h1\u003e\n\u003cp\u003e하나의 Service 에 Pod 가 연결 되어 있는 상태에서 Pod 를 하나 더 생성 할 건데 이 Pod 는 Container 에 HostPath 로 Node 의 Volume 이 연결되어 있다. 기본적으로\nReadinessProbe 와 LivenessProbe 는 사용 목적만 다를 뿐이고 설정할 수 있는 내용은 동일하다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-07.png\" alt=\"0014-07\"\u003e\u003c/p\u003e\n\u003cp\u003e공통으로 들어가는 속성들을 보면 크게 httpGet, Exec, tcpSocket 으로 해당 Application 의 상태를 확인할 수 있다.\u003c/p\u003e\u003ch2\u003ehttpGet\u003c/h2\u003e\n\u003cp\u003ePort, Host, Path, HttpHeader, Scheme 을 확인할 수 있다.\u003c/p\u003e"])</script><script>self.__next_f.push([1,"12:Te67,"])</script><script>self.__next_f.push([1,"\u003ch2\u003eExec\u003c/h2\u003e\n\u003cp\u003eCommand 를 사용해서 특정 명령어를 전송하여 그에 따른 결과를 확인할 수 있다.\u003c/p\u003e\u003ch2\u003etcpSocket\u003c/h2\u003e\n\u003cp\u003ePort, Host 를 통해 ReadinessProbe 와 LivenessProbe 의 성공 여부를 확인할 수 있다.\u003c/p\u003e\n\u003cp\u003e추가로 설정할 수 있는 옵션 값이 있다.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003einitialDelaySeconds\n\u003cul\u003e\n\u003cli\u003edefault : 0 초\u003c/li\u003e\n\u003cli\u003e최초 Probe 를 하기 전에 딜레이 시간\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eperiodSeconds\n\u003cul\u003e\n\u003cli\u003edefault : 10 초\u003c/li\u003e\n\u003cli\u003eProbe 를 체크하는 시간의 간격\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003etimeoutSeconds\n\u003cul\u003e\n\u003cli\u003edefault : 1 초\u003c/li\u003e\n\u003cli\u003e결과가 도착해야 하는 시간\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003esuccessThreshold\n\u003cul\u003e\n\u003cli\u003edefault : 1 회\u003c/li\u003e\n\u003cli\u003e몇 번 성공 결과를 받아야 정말 성공인지 설정\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003efailureThreshold\n\u003cul\u003e\n\u003cli\u003edefault : 3 회\u003c/li\u003e\n\u003cli\u003e몇 번 실패 결과를 받아야 정말 실패인지 설정\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch1\u003eReadinessProbe\u003c/h1\u003e\n\u003cp\u003eExec 를 사용해서 Command 로 ready.txt 파일을 조회 한다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-08.png\" alt=\"0014-08\"\u003e\u003c/p\u003e\n\u003cp\u003e최초 delay 5초, 체크 간격 10초, 3번 성공 시 정상 구동으로 설정했다면 Pod 를 만들 때 Node 가 Schedule 되고 이미지가 다운 받아 지면서 Pod 와 Container 상태는 Running 이\n되지만 이 Probe 가 성공하기 전까지는 Condition 에 Container Ready 상태와 Ready 상태가 false 로 남아 있고 EndPoint 에서는 이 Pod 의 IP 를 NotReadyAddr 로\n간주하고 Service 에 연결하지 않는다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-09.png\" alt=\"0014-09\"\u003e\u003c/p\u003e\n\u003cp\u003ek8s 는 ReadinessProbe 의 내용 대로 Application 의 기동 상태를 체크하는데, Container 상태가 Running 이 되면 최초 5초간 지연 하고 있다가 5초가 지나면 ready.txt\n파일이 있는지 체크해보고, 파일이 없으면 10초 후에 다시 체크를 하게 된다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-10.png\" alt=\"0014-10\"\u003e\u003c/p\u003e\n\u003cp\u003e이 Node 에 Ready.txt 라는 데이터를 추가하면 Container 의 Volume 과 연결 되어 있기 때문에 다음에 ReadinessProbe 를 체크할 때 성공 결과를 받게 된다. 그리고 3번 성공하게\n되면 Condition 의 상태는 true 가 되고 EndPoint 도 정상적으로 Address 로 간주 하면서 Service 와 연결 되게 된다.\u003c/p\u003e\n\u003ch1\u003eLivenessProbe\u003c/h1\u003e\n\u003cp\u003e하나의 Service 에 두 개의 Pod 가 Running 되고 있는 상태를 가정 한다. 이 중 한 Application 의 내용을 보면 /health 라는 요청을 보내면 Status 로 200을 주면서 서비스가\n정상 운영 중이라는 Health Check 가 만들어져 있다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-11.png\" alt=\"0014-11\"\u003e\u003c/p\u003e\n\u003cp\u003e그리고 이 Container 에는 LivenessProbe 가 설정되어 있고, 내용은 httpGet 으로 path에 /health 경로를 체크 한다. 옵션으로는 최초 5초 지연과 10초 간격 체크 그리고 3번 실패\n할 경우 Pod 가 재시작 하도록 설정 했다.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/tech-blog/resources/images/kubernetes/0014-12.png\" alt=\"0014-12\"\u003e\u003c/p\u003e\n\u003cp\u003ek8s 가 httpGet 으로 5초 후에 해당 path 를 체크해보고 200 응답을 받을 것이다. 그리고 10초 후 다시 체크할 때고 200 응답을 받으면서 서비스가 정상 운영 중이라고 판단 하게 된다. 그러던 중\n어느 순간 path 를 호출했을 때 Internal Server Error 를 발생 하면서 500 응답을 받았다고 하자. 하지만 Pod 는 Running 상태로 남아 있는다. 그렇게 3번을 500응답을 받게 되면\nk8s 는 문제가 있다고 판단하고 이 Pod 를 Restart 한다.\u003c/p\u003e"])</script><script>self.__next_f.push([1,"6:[[\"$\",\"div\",null,{\"className\":\"$undefined\",\"children\":[[\"$\",\"header\",null,{\"className\":\"PostHeader_postHeader__OohTH\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"PostHeader_title__NoKGt\",\"children\":\"Pod - ReadinessProbe, LivenessProb\"}],[\"$\",\"p\",null,{\"className\":\"PostHeader_description__moC_r\",\"children\":\"\"}],[\"$\",\"div\",null,{\"className\":\"PostHeader_meta__9Swgx\",\"children\":[[\"$\",\"span\",null,{\"className\":\"$undefined\",\"children\":\"nimkoes\"}],[\"$\",\"span\",null,{\"className\":\"$undefined\",\"children\":\"2021-03-02\"}]]}],[\"$\",\"div\",null,{\"className\":\"PostHeader_tags__lGQ1Q\",\"children\":[[\"$\",\"span\",\"Kubernetes\",{\"className\":\"PostHeader_tag__Jf7BC\",\"children\":\"Kubernetes\"}],[\"$\",\"span\",\"k8s\",{\"className\":\"PostHeader_tag__Jf7BC\",\"children\":\"k8s\"}],[\"$\",\"span\",\"infra\",{\"className\":\"PostHeader_tag__Jf7BC\",\"children\":\"infra\"}]]}]]}],[\"$\",\"$Le\",null,{}],[\"$\",\"article\",null,{\"className\":\"page_markdown__SVl4d\",\"children\":[[\"$\",\"$Lf\",null,{\"className\":\"page_topAd__ctbB7\"}],[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$10\"}}],[\"$\",\"$L11\",null,{\"className\":\"page_middleAd__4qBOv\",\"client\":\"ca-pub-6151583773425822\",\"slot\":\"your-ad-slot-id\"}],[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$12\"}}],[\"$\",\"$L11\",null,{\"className\":\"page_bottomAd__f0OO_\",\"client\":\"ca-pub-6151583773425822\",\"slot\":\"your-ad-slot-id\"}]]}]]}],[\"$\",\"div\",null,{\"className\":\"page_floatingButtons__qJiZU\",\"children\":[\"$\",\"$L13\",null,{}]}],[\"$\",\"$L14\",null,{}]]\n"])</script><script>self.__next_f.push([1,"b:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Pod - ReadinessProbe, LivenessProb | Nimkoes Tech Blog\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"기본 설명\"}],[\"$\",\"meta\",\"4\",{\"name\":\"application-name\",\"content\":\"Nimkoes Tech Blog\"}],[\"$\",\"link\",\"5\",{\"rel\":\"author\",\"href\":\"https://nimkoes.github.io/tech-blog\"}],[\"$\",\"meta\",\"6\",{\"name\":\"author\",\"content\":\"Nimkoes\"}],[\"$\",\"link\",\"7\",{\"rel\":\"manifest\",\"href\":\"/tech-blog/site.webmanifest\",\"crossOrigin\":\"use-credentials\"}],[\"$\",\"meta\",\"8\",{\"name\":\"keywords\",\"content\":\"tech-blog,backend,software architect,infrastructure,development\"}],[\"$\",\"meta\",\"9\",{\"name\":\"creator\",\"content\":\"Nimkoes\"}],[\"$\",\"meta\",\"10\",{\"name\":\"publisher\",\"content\":\"Nimkoes\"}],[\"$\",\"meta\",\"11\",{\"name\":\"robots\",\"content\":\"index, follow, nocache\"}],[\"$\",\"meta\",\"12\",{\"name\":\"googlebot\",\"content\":\"index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1\"}],[\"$\",\"meta\",\"13\",{\"name\":\"category\",\"content\":\"technology\"}],[\"$\",\"link\",\"14\",{\"rel\":\"canonical\",\"href\":\"https://nimkoes.github.io/tech-blog\"}],[\"$\",\"link\",\"15\",{\"rel\":\"alternate\",\"hrefLang\":\"ko-KR\",\"href\":\"https://nimkoes.github.io/tech-blog\"}],[\"$\",\"meta\",\"16\",{\"name\":\"format-detection\",\"content\":\"telephone=no, address=no, email=no\"}],[\"$\",\"meta\",\"17\",{\"name\":\"google-adsense-account\",\"content\":\"ca-pub-6151583773425822\"}],[\"$\",\"meta\",\"18\",{\"property\":\"og:title\",\"content\":\"Nimkoes Tech Blog - 개발자의 기술 이야기\"}],[\"$\",\"meta\",\"19\",{\"property\":\"og:description\",\"content\":\"I work diligently to become lazy ☕\"}],[\"$\",\"meta\",\"20\",{\"property\":\"og:url\",\"content\":\"https://nimkoes.github.io/tech-blog\"}],[\"$\",\"meta\",\"21\",{\"property\":\"og:site_name\",\"content\":\"Nimkoes Tech Blog\"}],[\"$\",\"meta\",\"22\",{\"property\":\"og:locale\",\"content\":\"ko_KR\"}],[\"$\",\"meta\",\"23\",{\"property\":\"og:image\",\"content\":\"https://nimkoes.github.io/tech-blog/og-image.png\"}],[\"$\",\"meta\",\"24\",{\"property\":\"og:image:width\",\"content\":\"1200\"}],[\"$\",\"meta\",\"25\",{\"property\":\"og:image:height\",\"content\":\"630\"}],[\"$\",\"meta\",\"26\",{\"property\":\"og:image:alt\",\"content\":\"Nimkoes Tech Blog\"}],[\"$\",\"meta\",\"27\",{\"property\":\"og:image:type\",\"content\":\"image/png\"}],[\"$\",\"meta\",\"28\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"29\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"30\",{\"name\":\"twitter:site\",\"content\":\"@nimkoes\"}],[\"$\",\"meta\",\"31\",{\"name\":\"twitter:creator\",\"content\":\"@nimkoes\"}],[\"$\",\"meta\",\"32\",{\"name\":\"twitter:title\",\"content\":\"Nimkoes Tech Blog\"}],[\"$\",\"meta\",\"33\",{\"name\":\"twitter:description\",\"content\":\"I work diligently to become lazy ☕\"}],[\"$\",\"meta\",\"34\",{\"name\":\"twitter:image\",\"content\":\"https://nimkoes.github.io/tech-blog/og-image.png\"}],[\"$\",\"link\",\"35\",{\"rel\":\"icon\",\"href\":\"/tech-blog/favicon.ico\",\"sizes\":\"any\"}],[\"$\",\"link\",\"36\",{\"rel\":\"icon\",\"href\":\"/tech-blog/icon.svg\",\"type\":\"image/svg+xml\"}],[\"$\",\"link\",\"37\",{\"rel\":\"icon\",\"href\":\"/tech-blog/favicon-32x32.png\",\"sizes\":\"32x32\",\"type\":\"image/png\"}],[\"$\",\"link\",\"38\",{\"rel\":\"icon\",\"href\":\"/tech-blog/favicon-16x16.png\",\"sizes\":\"16x16\",\"type\":\"image/png\"}],[\"$\",\"link\",\"39\",{\"rel\":\"apple-touch-icon\",\"href\":\"/tech-blog/apple-touch-icon.png\",\"sizes\":\"180x180\",\"type\":\"image/png\"}],[\"$\",\"link\",\"40\",{\"rel\":\"mask-icon\",\"href\":\"/tech-blog/safari-pinned-tab.svg\",\"color\":\"#5bbad5\"}],[\"$\",\"meta\",\"41\",{\"name\":\"next-size-adjust\"}]]\n"])</script><script>self.__next_f.push([1,"5:null\n"])</script></body></html>